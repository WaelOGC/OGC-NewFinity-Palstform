# OGC NewFinity — Backend Storage Management & Bucket Lifecycle Rules (v1.0)

## 1. Introduction

This document defines the storage architecture, bucket organization, lifecycle policies, cleanup rules, and security controls for asset storage within the OGC NewFinity backend.

The Storage Management Engine ensures:

- Secure and organized file storage
- Efficient bucket separation
- Automated cleanup and lifecycle transitions
- Predictable storage costs
- Compliance with file retention rules
- Safe public and private asset handling

This specification applies to all file operations across backend services.

## 2. Storage Architecture Overview

### 2.1 Storage Provider

OGC NewFinity uses:

- Cloud Object Storage (S3-compatible)
- Local development bucket (for dev/test)

### 2.2 Bucket Strategy

Buckets are separated by purpose:

| Bucket | Purpose |
|--------|---------|
| user-uploads | Regular user-generated content |
| ai-outputs | Images, documents, and files generated by Amy AI |
| challenge-submissions | Challenge attachments, media, or proofs |
| platform-assets | Logos, UI assets, system files |
| temp-files | Short-lived temporary files |
| logs-archive | Bulk log exports and zipped archives |

Each bucket is isolated with its own access rules and lifecycle policy.

## 3. Bucket Access Rules

### 3.1 Public Access Rules

Only specific files may be public:

- Thumbnails
- Challenge banners
- Public assets (icons, images)

All other files must remain private by default.

### 3.2 Private Access Rules

Private buckets require:

- Signed URL access
- Expiration limit (default: 15 minutes)
- No direct public link exposure

### 3.3 Encryption

All buckets must:

- Use server-side encryption (AES-256)
- Use HTTPS-only endpoints

## 4. File Categories & Validation Rules

### 4.1 Allowed File Types

- Images: jpg, jpeg, png, webp
- Documents: pdf, txt, md
- AI outputs: supported formats depending on the tool

### 4.2 Blocked File Types

- Executables
- Scripts (js, php, py)
- Archive bombs
- Dangerous MIME types

### 4.3 File Size Limits

- User uploads: max 10 MB
- Challenge submissions: max 25 MB
- AI output: max 50 MB

## 5. Lifecycle Management

### 5.1 Retention Rules

| Bucket | Retention |
|--------|-----------|
| temp-files | 24 hours |
| challenge-submissions | 1 year |
| ai-outputs | 90 days |
| logs-archive | 180 days |
| user-uploads | Permanent unless deleted |

### 5.2 Automated Transitions

Files can automatically transition:

- From standard storage → infrequent-access
- From infrequent-access → archive tier
- From archive → deletion

### 5.3 Event-Driven Cleanup

Triggers:

- Challenge ended → archive submissions
- User deleted → purge user-uploads files
- Log rotation event → move logs to archive

## 6. Storage Cleanup Jobs

Scheduled cleanup tasks include:

- Removing expired temp files
- Cleaning incomplete uploads
- Archiving old logs
- Removing orphaned files
- Enforcing retention policies

Cleanup is executed via the Worker Queue & Scheduler (Document 89).

## 7. Upload Flow Requirements

### 7.1 Upload Validation

Each upload is validated for:

- File size
- MIME type
- File extension
- Virus scan (future enhancement)

### 7.2 Secure Upload Flow

Flow:

1. Client requests upload token
2. Server issues signed upload URL (expires 5 minutes)
3. Client uploads directly to storage
4. Server validates metadata
5. Database record created

No backend server should directly handle binary uploads.

## 8. Download Flow Requirements

### 8.1 Private File Download

Access via:

- Signed URL
- Temporary access token
- Permission validation

### 8.2 Public File Download

Only from:

- platform-assets
- Approved public challenge banners
- Approved thumbnails

## 9. Folder Structure (Optional Prefixes)

Each bucket uses prefixes to keep structure consistent:

```
user-uploads/
   {userId}/
      {fileId}

challenge-submissions/
   {challengeId}/
      {submissionId}/

ai-outputs/
   {jobId}/
      outputs/
```

This ensures predictable organization and easier cleanup.

## 10. Logging Requirements

All storage actions must log:

- userId
- bucket
- file key
- operation type (upload/download/delete)
- timestamp
- IP (if applicable)

Cleanup tasks must log:

- number of files removed
- bucket affected
- total storage reclaimed

## 11. Performance Requirements

- Signed URL generation < 5 ms
- Upload latency dependent on client
- List operations must use pagination
- Cleanup job should not exceed 60 seconds per batch
- Lifecycle transitions handled in background

## 12. Security Requirements

- No public write access
- Mandatory encryption
- Signed URLs only
- Anti-hotlinking enforcement
- No direct directory listings
- Download rate limiting (per IP and user)

## 13. Future Enhancements

- AI-driven storage optimization
- Real-time storage usage dashboards
- Duplicate asset detection
- Virus scanning
- User storage quotas
- Cold storage analytics

## 14. Conclusion

This document establishes the complete set of rules for Storage Management & Bucket Lifecycle Operations in OGC NewFinity, ensuring secure, organized, and scalable asset management across all backend systems.

